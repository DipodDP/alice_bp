# High-Level Design: Secure Storage of Telegram Identifiers

## 1. Introduction

This document outlines the high-level design for a secure storage mechanism for Telegram identifiers in the `alice_bp` application. The current implementation stores these identifiers in plaintext, which is a security risk. This design proposes a solution based on hashing to mitigate this risk.

## 2. Chosen Protection Pattern: Keyed Hashing (HMAC)

To protect the Telegram identifiers, we will use a keyed hash function (HMAC) with SHA-256. This approach was chosen for the following reasons:

*   **Security**: HMAC is a standard, well-vetted cryptographic algorithm that provides message authentication and integrity. By using a secret key, it prevents an attacker with only database access from pre-computing a rainbow table of all possible Telegram IDs to their corresponding hashes.
*   **Performance**: HMAC-SHA256 is a fast and efficient algorithm, which is important for a high-throughput system. The lookup performance will be similar to the current implementation, as we will be querying an indexed column.
*   **Simplicity**: This approach is relatively simple to implement and does not require significant changes to the existing architecture.

### Alternatives Considered

*   **Argon2/scrypt**: These are key derivation functions designed for password hashing. While they are more resistant to brute-force attacks, they are also much slower than HMAC. Since the primary threat is a database leak and not a brute-force attack on a single user's ID, the performance overhead of Argon2/scrypt is not justified for this use case.
*   **Envelope Encryption**: This involves encrypting the Telegram ID with a data encryption key (DEK) and then encrypting the DEK with a key encryption key (KEK). This is a more complex solution that is better suited for encrypting larger pieces of data. For a short identifier like a Telegram ID, HMAC provides sufficient protection with less complexity.

## 3. Architecture Diagram (Textual)

```
+-----------------+      +----------------------+      +--------------------+
|  Telegram User  | <--> |  tgbot_bp (aiogram)  | <--> | alice_bp (Django)  |
+-----------------+      +----------------------+      +--------------------+
                             |                                  |
                             | 1. Get Telegram ID               | 5. Store/lookup hashed ID
                             | 2. Hash ID with HMAC             |
                             | 3. Send hashed ID to API         |
                             |                                  |
                             v                                  v
                       +----------------+             +--------------------+
                       |  Secret Key    |             |  Database          |
                       | (env var)      |             | (stores hashed ID) |
                       +----------------+             +--------------------+
```

## 4. Mapping of Responsibilities

*   **`tgbot_bp` (Telegram Bot)**:
    *   Responsible for receiving the user's Telegram ID from the `aiogram` framework.
    *   Responsible for hashing the Telegram ID using HMAC-SHA256 with a secret key.
    *   Responsible for sending the **hashed** Telegram ID to the `alice_bp` API.
    *   The secret key will be stored as an environment variable (e.g., `TELEGRAM_ID_HMAC_KEY`).

*   **`alice_bp` (Django Backend)**:
    *   Responsible for storing the **hashed** Telegram ID in the `AliceUser` model's `telegram_user_id` field. The field type will be changed to `CharField` with a length of 64 to accommodate the hex-encoded HMAC-SHA256 hash.
    *   Responsible for updating its API endpoints and queries to work with the hashed ID.
    *   The secret key will **not** be needed by this service, which improves security.

*   **Database**:
    *   The `alice_skill_aliceuser` table will store the hashed Telegram ID in the `telegram_user_id` column. The column will be indexed to ensure fast lookups.

*   **Key Management**:
    *   The HMAC secret key will be a high-entropy string (e.g., generated by `openssl rand -hex 32`).
    *   It will be stored as an environment variable in both the `tgbot_bp` and `alice_bp` (for migration) environments. It will not be checked into version control.

## 5. Data Migration Strategy

A data migration will be required to update the existing plaintext Telegram IDs to the new hashed format. The migration will be implemented as a Django management command with the following features:

*   **Idempotent**: The script can be run multiple times without causing issues.
*   **Resumable**: The script can be stopped and restarted without losing progress.
*   **Dry-run mode**: The script will have a `--dry-run` flag to simulate the migration without making any changes to the database.
*   **Verification**: The script will include a verification step to ensure that the migration was successful.

The migration script will read the plaintext `telegram_user_id`s, compute the HMAC-SHA256 hash using the secret key, and update the `telegram_user_id` field with the hashed value.
